<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        
        <title>
            
    
    What&#8217;s New in SQLAlchemy 1.1?
 &mdash;
    SQLAlchemy 1.1 Documentation

        </title>

        
            <!-- begin iterate through SQLA + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/changelog.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
            <!-- end iterate through SQLA + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 1.1 Documentation" href="../index.html" />
        <link rel="up" title="Changes and Migration" href="index.html" />
        <link rel="next" title="1.1 Changelog" href="changelog_11.html" />
        <link rel="prev" title="Changes and Migration" href="index.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">1.1.0b1</span> | Release Date: not released
    </div>

    <h1>SQLAlchemy 1.1 Documentation</h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">


        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 1.1 Documentation</a></h3>

            <p id="sidebar-topnav">
                <a href="../contents.html">Contents</a> |
                <a href="../genindex.html">Index</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <input type="text" name="q" size="12" /> <input type="submit" value="Search" />
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        
        <h3>
            <a href="index.html" title="Changes and Migration">Changes and Migration</a>
        </h3>

        <ul>
<li class="selected"><span class="link-container first"><strong>What&#8217;s New in SQLAlchemy 1.1?</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="#introduction">Introduction</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#platform-installer-changes">Platform / Installer Changes</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="#setuptools-is-now-required-for-install">Setuptools is now required for install</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#enabling-disabling-c-extension-builds-is-only-via-environment-variable">Enabling / Disabling C Extension builds is only via environment variable</a></span></li>
</ul>
</li>
<li><span class="link-container first"><a class="reference external" href="#new-features-and-improvements-orm">New Features and Improvements - ORM</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="#new-session-lifecycle-events">New Session lifecycle events</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="#new-state-transition-events">New State Transition Events</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#new-object-state-deleted-is-added-deleted-objects-no-longer-persistent">New Object State &#8220;deleted&#8221; is added, deleted objects no longer &#8220;persistent&#8221;</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#strong-identity-map-is-deprecated">Strong Identity Map is Deprecated</a></span></li>
</ul>
</li>
<li><span class="link-container first"><a class="reference external" href="#changes-regarding-unhashable-types">Changes regarding &#8220;unhashable&#8221; types</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#specific-checks-added-for-passing-mapped-classes-instances-as-sql-literals">Specific checks added for passing mapped classes, instances as SQL literals</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#new-options-allowing-explicit-persistence-of-null-over-a-default">New options allowing explicit persistence of NULL over a default</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#further-fixes-to-single-table-inheritance-querying">Further Fixes to single-table inheritance querying</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#session-merge-resolves-pending-conflicts-the-same-as-persistent">Session.merge resolves pending conflicts the same as persistent</a></span></li>
</ul>
</li>
<li><span class="link-container first"><a class="reference external" href="#new-features-and-improvements-core">New Features and Improvements - Core</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="#the-autoincrement-directive-is-no-longer-implicitly-enabled-for-a-composite-primary-key-column">The <code class="docutils literal"><span class="pre">.autoincrement</span></code> directive is no longer implicitly enabled for a composite primary key column</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#a-union-or-similar-of-selects-with-limit-offset-order-by-now-parenthesizes-the-embedded-selects">A UNION or similar of SELECTs with LIMIT/OFFSET/ORDER BY now parenthesizes the embedded selects</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#array-support-added-to-core-new-any-and-all-operators">Array support added to Core; new ANY and ALL operators</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#new-function-features-within-group-array-agg-and-set-aggregate-functions">New Function features, &#8220;WITHIN GROUP&#8221;, array_agg and set aggregate functions</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#typedecorator-now-works-with-enum-boolean-schema-types-automatically">TypeDecorator now works with Enum, Boolean, &#8220;schema&#8221; types automatically</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#the-type-coerce-function-is-now-a-persistent-sql-element">The type_coerce function is now a persistent SQL element</a></span></li>
</ul>
</li>
<li><span class="link-container first"><a class="reference external" href="#key-behavioral-changes-orm">Key Behavioral Changes - ORM</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#key-behavioral-changes-core">Key Behavioral Changes - Core</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#dialect-improvements-and-changes-postgresql">Dialect Improvements and Changes - Postgresql</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="#array-and-json-types-now-correctly-specify-unhashable">ARRAY and JSON types now correctly specify &#8220;unhashable&#8221;</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#correct-sql-types-are-established-from-indexed-access-of-array-json-hstore">Correct SQL Types are Established from Indexed Access of ARRAY, JSON, HSTORE</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#the-json-cast-operation-now-requires-astext-is-called-explicitly">The JSON cast() operation now requires <code class="docutils literal"><span class="pre">.astext</span></code> is called explicitly</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#postgresql-json-null-is-inserted-as-expected-with-orm-operations-regardless-of-column-default-present">Postgresql JSON &#8220;null&#8221; is inserted as expected with ORM operations, regardless of column default present</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#new-json-null-constant-added">New JSON.NULL Constant Added</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#array-with-enum-will-now-emit-create-type-for-the-enum">ARRAY with ENUM will now emit CREATE TYPE for the ENUM</a></span></li>
</ul>
</li>
<li><span class="link-container first"><a class="reference external" href="#dialect-improvements-and-changes-mysql">Dialect Improvements and Changes - MySQL</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="#no-more-generation-of-an-implicit-key-for-composite-primary-key-w-auto-increment">No more generation of an implicit KEY for composite primary key w/ AUTO_INCREMENT</a></span></li>
</ul>
</li>
<li><span class="link-container first"><a class="reference external" href="#dialect-improvements-and-changes-sqlite">Dialect Improvements and Changes - SQLite</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="#improved-support-for-remote-schemas">Improved Support for Remote Schemas</a></span></li>
</ul>
</li>
<li><span class="link-container first"><a class="reference external" href="#dialect-improvements-and-changes-sql-server">Dialect Improvements and Changes - SQL Server</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="#string-varlength-types-no-longer-represent-max-explicitly-on-reflection">String / varlength types no longer represent &#8220;max&#8221; explicitly on reflection</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#the-legacy-schema-aliasing-flag-is-now-set-to-false">The legacy_schema_aliasing flag is now set to False</a></span></li>
</ul>
</li>
<li><span class="link-container first"><a class="reference external" href="#dialect-improvements-and-changes-oracle">Dialect Improvements and Changes - Oracle</a></span></li>
</ul>
</li>
<li><span class="link-container first"><a class="reference external" href="changelog_11.html">1.1 Changelog</a></span></li>
<li><span class="link-container first"><a class="reference external" href="changelog_10.html">1.0 Changelog</a></span></li>
<li><span class="link-container first"><a class="reference external" href="changelog_09.html">0.9 Changelog</a></span></li>
<li><span class="link-container first"><a class="reference external" href="changelog_08.html">0.8 Changelog</a></span></li>
<li><span class="link-container first"><a class="reference external" href="changelog_07.html">0.7 Changelog</a></span></li>
<li><span class="link-container first"><a class="reference external" href="changelog_06.html">0.6 Changelog</a></span></li>
<li><span class="link-container first"><a class="reference external" href="changelog_05.html">0.5 Changelog</a></span></li>
<li><span class="link-container first"><a class="reference external" href="changelog_04.html">0.4 Changelog</a></span></li>
<li><span class="link-container first"><a class="reference external" href="changelog_03.html">0.3 Changelog</a></span></li>
<li><span class="link-container first"><a class="reference external" href="changelog_02.html">0.2 Changelog</a></span></li>
<li><span class="link-container first"><a class="reference external" href="changelog_01.html">0.1 Changelog</a></span></li>
<li><span class="link-container first"><a class="reference external" href="migration_10.html">What&#8217;s New in SQLAlchemy 1.0?</a></span></li>
<li><span class="link-container first"><a class="reference external" href="migration_09.html">What&#8217;s New in SQLAlchemy 0.9?</a></span></li>
<li><span class="link-container first"><a class="reference external" href="migration_08.html">What&#8217;s New in SQLAlchemy 0.8?</a></span></li>
<li><span class="link-container first"><a class="reference external" href="migration_07.html">What&#8217;s New in SQLAlchemy 0.7?</a></span></li>
<li><span class="link-container first"><a class="reference external" href="migration_06.html">What&#8217;s New in SQLAlchemy 0.6?</a></span></li>
<li><span class="link-container first"><a class="reference external" href="migration_05.html">What&#8217;s new in SQLAlchemy 0.5?</a></span></li>
<li><span class="link-container first"><a class="reference external" href="migration_04.html">What&#8217;s new in SQLAlchemy 0.4?</a></span></li>
</ul>



        </div>

    </div>

    

    <div id="docs-body" class="withsidebar" >
        
<div class="section" id="what-s-new-in-sqlalchemy-1-1">
<h1>What&#8217;s New in SQLAlchemy 1.1?<a class="headerlink" href="#what-s-new-in-sqlalchemy-1-1" title="Permalink to this headline">¶</a></h1>
<div class="admonition-about-this-document admonition">
<p class="first admonition-title">About this Document</p>
<p>This document describes changes between SQLAlchemy version 1.0,
at the moment the current release series of SQLAlchemy,
and SQLAlchemy version 1.1, which is the current development
series of SQLAlchemy.</p>
<p>As the 1.1 series is under development, issues that are targeted
at this series can be seen under the
<a class="reference external" href="https://bitbucket.org/zzzeek/sqlalchemy/issues?milestone=1.1">1.1 milestone</a>.
Please note that the set of issues within the milestone is not fixed;
some issues may be moved to later milestones in order to allow
for a timely release.</p>
<p class="last">Document last updated: December 4, 2015</p>
</div>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This guide introduces what&#8217;s new in SQLAlchemy version 1.1,
and also documents changes which affect users migrating
their applications from the 1.0 series of SQLAlchemy to 1.1.</p>
<p>Please carefully review the sections on behavioral changes for
potentially backwards-incompatible changes in behavior.</p>
</div>
<div class="section" id="platform-installer-changes">
<h2>Platform / Installer Changes<a class="headerlink" href="#platform-installer-changes" title="Permalink to this headline">¶</a></h2>
<div class="section" id="setuptools-is-now-required-for-install">
<h3>Setuptools is now required for install<a class="headerlink" href="#setuptools-is-now-required-for-install" title="Permalink to this headline">¶</a></h3>
<p>SQLAlchemy&#8217;s <code class="docutils literal"><span class="pre">setup.py</span></code> file has for many years supported operation
both with Setuptools installed and without; supporting a &#8220;fallback&#8221; mode
that uses straight Distutils.  As a Setuptools-less Python environment is
now unheard of, and in order to support the featureset of Setuptools
more fully, in particular to support py.test&#8217;s integration with it,
<code class="docutils literal"><span class="pre">setup.py</span></code> now depends on Setuptools fully.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="../intro.html#installation"><span>Installation Guide</span></a></p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3489">#3489</a></p>
</div>
<div class="section" id="enabling-disabling-c-extension-builds-is-only-via-environment-variable">
<h3>Enabling / Disabling C Extension builds is only via environment variable<a class="headerlink" href="#enabling-disabling-c-extension-builds-is-only-via-environment-variable" title="Permalink to this headline">¶</a></h3>
<p>The C Extensions build by default during install as long as it is possible.
To disable C extension builds, the <code class="docutils literal"><span class="pre">DISABLE_SQLALCHEMY_CEXT</span></code> environment
variable was made available as of SQLAlchemy 0.8.6 / 0.9.4.  The previous
approach of using the <code class="docutils literal"><span class="pre">--without-cextensions</span></code> argument has been removed,
as it relies on deprecated features of setuptools.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="../intro.html#c-extensions"><span>Installing the C Extensions</span></a></p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3500">#3500</a></p>
</div>
</div>
<div class="section" id="new-features-and-improvements-orm">
<h2>New Features and Improvements - ORM<a class="headerlink" href="#new-features-and-improvements-orm" title="Permalink to this headline">¶</a></h2>
<div class="section" id="new-session-lifecycle-events">
<span id="change-2677"></span><h3>New Session lifecycle events<a class="headerlink" href="#new-session-lifecycle-events" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> has long supported events that allow some degree
of tracking of state changes to objects, including
<a class="reference internal" href="../orm/events.html#sqlalchemy.orm.events.SessionEvents.before_attach" title="sqlalchemy.orm.events.SessionEvents.before_attach"><code class="xref py py-meth docutils literal"><span class="pre">SessionEvents.before_attach()</span></code></a>, <a class="reference internal" href="../orm/events.html#sqlalchemy.orm.events.SessionEvents.after_attach" title="sqlalchemy.orm.events.SessionEvents.after_attach"><code class="xref py py-meth docutils literal"><span class="pre">SessionEvents.after_attach()</span></code></a>,
and <a class="reference internal" href="../orm/events.html#sqlalchemy.orm.events.SessionEvents.before_flush" title="sqlalchemy.orm.events.SessionEvents.before_flush"><code class="xref py py-meth docutils literal"><span class="pre">SessionEvents.before_flush()</span></code></a>.  The Session documentation also
documents major object states at <a class="reference internal" href="../orm/session_state_management.html#session-object-states"><span>Quickie Intro to Object States</span></a>.  However,
there has never been system of tracking objects specifically as they
pass through these transitions.  Additionally, the status of &#8220;deleted&#8221; objects
has historically been murky as the objects act somewhere between
the &#8220;persistent&#8221; and &#8220;detached&#8221; states.</p>
<p>To clean up this area and allow the realm of session state transition
to be fully transparent, a new series of events have been added that
are intended to cover every possible way that an object might transition
between states, and additionally the &#8220;deleted&#8221; status has been given
its own official state name within the realm of session object states.</p>
<div class="section" id="new-state-transition-events">
<h4>New State Transition Events<a class="headerlink" href="#new-state-transition-events" title="Permalink to this headline">¶</a></h4>
<p>Transitions between all states of an object such as <a class="reference internal" href="../glossary.html#term-persistent"><span class="xref std std-term">persistent</span></a>,
<a class="reference internal" href="../glossary.html#term-pending"><span class="xref std std-term">pending</span></a> and others can now be intercepted in terms of a
session-level event intended to cover a specific transition.
Transitions as objects move into a <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>, move out of a
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>, and even all the transitions which occur when the
transaction is rolled back using <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session.rollback" title="sqlalchemy.orm.session.Session.rollback"><code class="xref py py-meth docutils literal"><span class="pre">Session.rollback()</span></code></a>
are explicitly present in the interface of <a class="reference internal" href="../orm/events.html#sqlalchemy.orm.events.SessionEvents" title="sqlalchemy.orm.events.SessionEvents"><code class="xref py py-class docutils literal"><span class="pre">SessionEvents</span></code></a>.</p>
<p>In total, there are <strong>ten new events</strong>.  A summary of these events is in a
newly written documentation section <a class="reference internal" href="../orm/session_events.html#session-lifecycle-events"><span>Object Lifecycle Events</span></a>.</p>
</div>
<div class="section" id="new-object-state-deleted-is-added-deleted-objects-no-longer-persistent">
<h4>New Object State &#8220;deleted&#8221; is added, deleted objects no longer &#8220;persistent&#8221;<a class="headerlink" href="#new-object-state-deleted-is-added-deleted-objects-no-longer-persistent" title="Permalink to this headline">¶</a></h4>
<p>The <a class="reference internal" href="../glossary.html#term-persistent"><span class="xref std std-term">persistent</span></a> state of an object in the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> has
always been documented as an object that has a valid database identity;
however in the case of objects that were deleted within a flush, they
have always been in a grey area where they are not really &#8220;detached&#8221;
from the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> yet, because they can still be restored
within a rollback, but are not really &#8220;persistent&#8221; because their database
identity has been deleted and they aren&#8217;t present in the identity map.</p>
<p>To resolve this grey area given the new events, a new object state
<a class="reference internal" href="../glossary.html#term-deleted"><span class="xref std std-term">deleted</span></a> is introduced.  This state exists between the &#8220;persistent&#8221; and
&#8220;detached&#8221; states.  An object that is marked for deletion via
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session.delete" title="sqlalchemy.orm.session.Session.delete"><code class="xref py py-meth docutils literal"><span class="pre">Session.delete()</span></code></a> remains in the &#8220;persistent&#8221; state until a flush
proceeds; at that point, it is removed from the identity map, moves
to the &#8220;deleted&#8221; state, and the <a class="reference internal" href="../orm/events.html#sqlalchemy.orm.events.SessionEvents.persistent_to_deleted" title="sqlalchemy.orm.events.SessionEvents.persistent_to_deleted"><code class="xref py py-meth docutils literal"><span class="pre">SessionEvents.persistent_to_deleted()</span></code></a>
hook is invoked.  If the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> object&#8217;s transaction is rolled
back, the object is restored as persistent; the
<a class="reference internal" href="../orm/events.html#sqlalchemy.orm.events.SessionEvents.deleted_to_persistent" title="sqlalchemy.orm.events.SessionEvents.deleted_to_persistent"><code class="xref py py-meth docutils literal"><span class="pre">SessionEvents.deleted_to_persistent()</span></code></a> transition is called.  Otherwise
if the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> object&#8217;s transaction is committed,
the <a class="reference internal" href="../orm/events.html#sqlalchemy.orm.events.SessionEvents.deleted_to_detached" title="sqlalchemy.orm.events.SessionEvents.deleted_to_detached"><code class="xref py py-meth docutils literal"><span class="pre">SessionEvents.deleted_to_detached()</span></code></a> transition is invoked.</p>
<p>Additionally, the <a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.state.InstanceState.persistent" title="sqlalchemy.orm.state.InstanceState.persistent"><code class="xref py py-attr docutils literal"><span class="pre">InstanceState.persistent</span></code></a> accessor <strong>no longer returns
True</strong> for an object that is in the new &#8220;deleted&#8221; state; instead, the
<a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.state.InstanceState.deleted" title="sqlalchemy.orm.state.InstanceState.deleted"><code class="xref py py-attr docutils literal"><span class="pre">InstanceState.deleted</span></code></a> accessor has been enhanced to reliably
report on this new state.   When the object is detached, the <a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.state.InstanceState.deleted" title="sqlalchemy.orm.state.InstanceState.deleted"><code class="xref py py-attr docutils literal"><span class="pre">InstanceState.deleted</span></code></a>
returns False and the <a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.state.InstanceState.detached" title="sqlalchemy.orm.state.InstanceState.detached"><code class="xref py py-attr docutils literal"><span class="pre">InstanceState.detached</span></code></a> accessor is True
instead.  To determine if an object was deleted either in the current
transaction or in a previous transaction, use the
<a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.state.InstanceState.was_deleted" title="sqlalchemy.orm.state.InstanceState.was_deleted"><code class="xref py py-attr docutils literal"><span class="pre">InstanceState.was_deleted</span></code></a> accessor.</p>
</div>
<div class="section" id="strong-identity-map-is-deprecated">
<h4>Strong Identity Map is Deprecated<a class="headerlink" href="#strong-identity-map-is-deprecated" title="Permalink to this headline">¶</a></h4>
<p>One of the inspirations for the new series of transition events was to enable
leak-proof tracking of objects as they move in and out of the identity map,
so that a &#8220;strong reference&#8221; may be maintained mirroring the object
moving in and out of this map.  With this new capability, there is no longer
any need for the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session.params.weak_identity_map" title="sqlalchemy.orm.session.Session"><code class="xref py py-paramref docutils literal"><span class="pre">Session.weak_identity_map</span></code></a> parameter and the
corresponding <code class="xref py py-class docutils literal"><span class="pre">StrongIdentityMap</span></code> object.  This option has remained
in SQLAlchemy for many years as the &#8220;strong-referencing&#8221; behavior used to be
the only behavior available, and many applications were written to assume
this behavior.   It has long been recommended that strong-reference tracking
of objects not be an intrinsic job of the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> and instead
be an application-level construct built as needed by the application; the
new event model allows even the exact behavior of the strong identity map
to be replicated.   See <a class="reference internal" href="../orm/session_state_management.html#session-referencing-behavior"><span>Session Referencing Behavior</span></a> for a new
recipe illustrating how to replace the strong identity map.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2677">#2677</a></p>
</div>
</div>
<div class="section" id="changes-regarding-unhashable-types">
<span id="change-3499"></span><h3>Changes regarding &#8220;unhashable&#8221; types<a class="headerlink" href="#changes-regarding-unhashable-types" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal"><span class="pre">Query</span></code></a> object has a well-known behavior of &#8220;deduping&#8221;
returned rows that contain at least one ORM-mapped entity (e.g., a
full mapped object, as opposed to individual column values). The
primary purpose of this is so that the handling of entities works
smoothly in conjunction with the identity map, including to
accommodate for the duplicate entities normally represented within
joined eager loading, as well as when joins are used for the purposes
of filtering on additional columns.</p>
<p>This deduplication relies upon the hashability of the elements within
the row.  With the introduction of Postgresql&#8217;s special types like
<a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.ARRAY" title="sqlalchemy.dialects.postgresql.ARRAY"><code class="xref py py-class docutils literal"><span class="pre">postgresql.ARRAY</span></code></a>, <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.HSTORE" title="sqlalchemy.dialects.postgresql.HSTORE"><code class="xref py py-class docutils literal"><span class="pre">postgresql.HSTORE</span></code></a> and
<a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON" title="sqlalchemy.dialects.postgresql.JSON"><code class="xref py py-class docutils literal"><span class="pre">postgresql.JSON</span></code></a>, the experience of types within rows being
unhashable and encountering problems here is more prevalent than
it was previously.</p>
<p>In fact, SQLAlchemy has since version 0.8 included a flag on datatypes that
are noted as &#8220;unhashable&#8221;, however this flag was not used consistently
on built in types.  As described in <a class="reference internal" href="#change-3499-postgresql"><span>ARRAY and JSON types now correctly specify &#8220;unhashable&#8221;</span></a>, this
flag is now set consistently for all of Postgresql&#8217;s &#8220;structural&#8221; types.</p>
<p>The &#8220;unhashable&#8221; flag is also set on the <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.NullType" title="sqlalchemy.types.NullType"><code class="xref py py-class docutils literal"><span class="pre">NullType</span></code></a> type,
as <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.NullType" title="sqlalchemy.types.NullType"><code class="xref py py-class docutils literal"><span class="pre">NullType</span></code></a> is used to refer to any expression of unknown
type.</p>
<p>Additionally, the treatment of a so-called &#8220;unhashable&#8221; type is slightly
different than its been in previous releases; internally we are using
the <code class="docutils literal"><span class="pre">id()</span></code> function to get a &#8220;hash value&#8221; from these structures, just
as we would any ordinary mapped object.   This replaces the previous
approach which applied a counter to the object.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3499">#3499</a></p>
</div>
<div class="section" id="specific-checks-added-for-passing-mapped-classes-instances-as-sql-literals">
<span id="change-3321"></span><h3>Specific checks added for passing mapped classes, instances as SQL literals<a class="headerlink" href="#specific-checks-added-for-passing-mapped-classes-instances-as-sql-literals" title="Permalink to this headline">¶</a></h3>
<p>The typing system now has specific checks for passing of SQLAlchemy
&#8220;inspectable&#8221; objects in contexts where they would otherwise be handled as
literal values.   Any SQLAlchemy built-in object that is legal to pass as a
SQL value includes a method <code class="docutils literal"><span class="pre">__clause_element__()</span></code> which provides a
valid SQL expression for that object.  For SQLAlchemy objects that
don&#8217;t provide this, such as mapped classes, mappers, and mapped
instances, a more informative error message is emitted rather than
allowing the DBAPI to receive the object and fail later.  An example
is illustrated below, where a string-based attribute <code class="docutils literal"><span class="pre">User.name</span></code> is
compared to a full instance of <code class="docutils literal"><span class="pre">User()</span></code>, rather than against a
string value:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">some_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">q</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">some_user</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">sqlalchemy.exc.ArgumentError: Object &lt;__main__.User object at 0x103167e90&gt; is not legal as a SQL literal value</span></pre></div>
</div>
<p>The exception is now immediate when the comparison is made between
<code class="docutils literal"><span class="pre">User.name</span> <span class="pre">==</span> <span class="pre">some_user</span></code>.  Previously, a comparison like the above
would produce a SQL expression that would only fail once resolved
into a DBAPI execution call; the mapped <code class="docutils literal"><span class="pre">User</span></code> object would
ultimately become a bound parameter that would be rejected by the
DBAPI.</p>
<p>Note that in the above example, the expression fails because
<code class="docutils literal"><span class="pre">User.name</span></code> is a string-based (e.g. column oriented) attribute.
The change does <em>not</em> impact the usual case of comparing a many-to-one
relationship attribute to an object, which is handled distinctly:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="c"># Address.user refers to the User mapper, so</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c"># this is of course still OK!</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">q</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">some_user</span><span class="p">)</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3321">#3321</a></p>
</div>
<div class="section" id="new-options-allowing-explicit-persistence-of-null-over-a-default">
<span id="change-3250"></span><h3>New options allowing explicit persistence of NULL over a default<a class="headerlink" href="#new-options-allowing-explicit-persistence-of-null-over-a-default" title="Permalink to this headline">¶</a></h3>
<p>Related to the new JSON-NULL support added to Postgresql as part of
<a class="reference internal" href="#change-3514"><span>Postgresql JSON &#8220;null&#8221; is inserted as expected with ORM operations, regardless of column default present</span></a>, the base <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal"><span class="pre">TypeEngine</span></code></a> class now supports
a method <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine.evaluates_none" title="sqlalchemy.types.TypeEngine.evaluates_none"><code class="xref py py-meth docutils literal"><span class="pre">TypeEngine.evaluates_none()</span></code></a> which allows a positive set
of the <code class="docutils literal"><span class="pre">None</span></code> value on an attribute to be persisted as NULL, rather than
omitting the column from the INSERT statement, which has the effect of using
the column-level default.  This allows a mapper-level
configuration of the existing object-level technique of assigning
<code class="xref py py-func docutils literal"><span class="pre">sql.null()</span></code> to the attribute.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="../orm/persistence_techniques.html#session-forcing-null"><span>Forcing NULL on a column with a default</span></a></p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3250">#3250</a></p>
</div>
<div class="section" id="further-fixes-to-single-table-inheritance-querying">
<span id="change-3582"></span><h3>Further Fixes to single-table inheritance querying<a class="headerlink" href="#further-fixes-to-single-table-inheritance-querying" title="Permalink to this headline">¶</a></h3>
<p>Continuing from 1.0&#8217;s <a class="reference internal" href="migration_10.html#migration-3177"><span>Change to single-table-inheritance criteria when using from_self(), count()</span></a>, the <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal"><span class="pre">Query</span></code></a> should
no longer inappropriately add the &#8220;single inheritance&#8221; criteria when the
query is against a subquery expression such as an exists:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Widget</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;widget&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;polymorphic_on&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">FooWidget</span><span class="p">(</span><span class="n">Widget</span><span class="p">):</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="s">&#39;foo&#39;</span><span class="p">}</span>

<span class="n">q</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">FooWidget</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">FooWidget</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s">&#39;bar&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

<span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p>Produces:</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT EXISTS (SELECT 1
FROM widget
WHERE widget.data = :data_1 AND widget.type IN (:type_1)) AS anon_1</pre></div>
</div>
<p>The IN clause on the inside is appropriate, in order to limit to FooWidget
objects, however previously the IN clause would also be generated a second
time on the outside of the subquery.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3582">#3582</a></p>
</div>
<div class="section" id="session-merge-resolves-pending-conflicts-the-same-as-persistent">
<span id="change-3601"></span><h3>Session.merge resolves pending conflicts the same as persistent<a class="headerlink" href="#session-merge-resolves-pending-conflicts-the-same-as-persistent" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session.merge" title="sqlalchemy.orm.session.Session.merge"><code class="xref py py-meth docutils literal"><span class="pre">Session.merge()</span></code></a> method will now track the identities of objects given
within a graph to maintain primary key uniqueness before emitting an INSERT.
When duplicate objects of the same identity are encountered, non-primary-key
attributes are <strong>overwritten</strong> as the objects are encountered, which is
essentially non-deterministic.   This behavior matches that of how persistent
objects, that is objects that are already located in the database via
primary key, are already treated, so this behavior is more internally
consistent.</p>
<p>Given:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
<span class="n">u1</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Order</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">&#39;o1&#39;</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="n">Address</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">email_address</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">)),</span>
    <span class="n">Order</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">&#39;o2&#39;</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="n">Address</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">email_address</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">)),</span>
    <span class="n">Order</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">&#39;o3&#39;</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="n">Address</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">email_address</span><span class="o">=</span><span class="s">&#39;c&#39;</span><span class="p">))</span>
<span class="p">]</span>

<span class="n">sess</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
<span class="n">sess</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span></pre></div>
</div>
<p>Above, we merge a <code class="docutils literal"><span class="pre">User</span></code> object with three new <code class="docutils literal"><span class="pre">Order</span></code> objects, each referring to
a distinct <code class="docutils literal"><span class="pre">Address</span></code> object, however each is given the same primary key.
The current behavior of <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session.merge" title="sqlalchemy.orm.session.Session.merge"><code class="xref py py-meth docutils literal"><span class="pre">Session.merge()</span></code></a> is to look in the identity
map for this <code class="docutils literal"><span class="pre">Address</span></code> object, and use that as the target.   If the object
is present, meaning that the database already has a row for <code class="docutils literal"><span class="pre">Address</span></code> with
primary key &#8220;1&#8221;, we can see that the <code class="docutils literal"><span class="pre">email_address</span></code> field of the <code class="docutils literal"><span class="pre">Address</span></code>
will be overwritten three times, in this case with the values a, b and finally
c.</p>
<p>However, if the <code class="docutils literal"><span class="pre">Address</span></code> row for primary key &#8220;1&#8221; were not present, <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session.merge" title="sqlalchemy.orm.session.Session.merge"><code class="xref py py-meth docutils literal"><span class="pre">Session.merge()</span></code></a>
would instead create three separate <code class="docutils literal"><span class="pre">Address</span></code> instances, and we&#8217;d then get
a primary key conflict upon INSERT.  The new behavior is that the proposed
primary key for these <code class="docutils literal"><span class="pre">Address</span></code> objects are tracked in a separate dictionary
so that we merge the state of the three proposed <code class="docutils literal"><span class="pre">Address</span></code> objects onto
one <code class="docutils literal"><span class="pre">Address</span></code> object to be inserted.</p>
<p>It may have been preferable if the original case emitted some kind of warning
that conflicting data were present in a single merge-tree, however the
non-deterministic merging of values has been the behavior for many
years for the persistent case; it now matches for the pending case.   A
feature that warns for conflicting values could still be feasible for both
cases but would add considerable performance overhead as each column value
would have to be compared during the merge.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3601">#3601</a></p>
</div>
</div>
<div class="section" id="new-features-and-improvements-core">
<h2>New Features and Improvements - Core<a class="headerlink" href="#new-features-and-improvements-core" title="Permalink to this headline">¶</a></h2>
<div class="section" id="the-autoincrement-directive-is-no-longer-implicitly-enabled-for-a-composite-primary-key-column">
<span id="change-3216"></span><h3>The <code class="docutils literal"><span class="pre">.autoincrement</span></code> directive is no longer implicitly enabled for a composite primary key column<a class="headerlink" href="#the-autoincrement-directive-is-no-longer-implicitly-enabled-for-a-composite-primary-key-column" title="Permalink to this headline">¶</a></h3>
<p>SQLAlchemy has always had the convenience feature of enabling the backend database&#8217;s
&#8220;autoincrement&#8221; feature for a single-column integer primary key; by &#8220;autoincrement&#8221;
we mean that the database column will include whatever DDL directives the
database provides in order to indicate an auto-incrementing integer identifier,
such as the SERIAL keyword on Postgresql or AUTO_INCREMENT on MySQL, and additionally
that the dialect will recieve these generated values from the execution
of a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.insert" title="sqlalchemy.schema.Table.insert"><code class="xref py py-meth docutils literal"><span class="pre">Table.insert()</span></code></a> construct using techniques appropriate to that
backend.</p>
<p>What&#8217;s changed is that this feature no longer turns on automatically for a
<em>composite</em> primary key; previously, a table definition such as:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Table</span><span class="p">(</span>
    <span class="s">&#39;some_table&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p>Would have &#8220;autoincrement&#8221; semantics applied to the <code class="docutils literal"><span class="pre">'x'</span></code> column, only
because it&#8217;s first in the list of primary key columns.  In order to
disable this, one would have to turn off <code class="docutils literal"><span class="pre">autoincrement</span></code> on all columns:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># old way</span>
<span class="n">Table</span><span class="p">(</span>
    <span class="s">&#39;some_table&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p>With the new behavior, the composite primary key will not have autoincrement
semantics unless a column is marked explcitly with <code class="docutils literal"><span class="pre">autoincrement=True</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># column &#39;y&#39; will be SERIAL/AUTO_INCREMENT/ auto-generating</span>
<span class="n">Table</span><span class="p">(</span>
    <span class="s">&#39;some_table&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p>In order to anticipate some potential backwards-incompatible scenarios,
the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.insert" title="sqlalchemy.schema.Table.insert"><code class="xref py py-meth docutils literal"><span class="pre">Table.insert()</span></code></a> construct will perform more thorough checks
for missing primary key values on composite primary key columns that don&#8217;t
have autoincrement set up; given a table such as:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Table</span><span class="p">(</span>
    <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p>An INSERT emitted with no values for this table will produce the exception:</p>
<div class="highlight-python"><div class="highlight"><pre>CompileError: Column &#39;b.x&#39; is marked as a member of the primary
key for table &#39;b&#39;, but has no Python-side or server-side default
generator indicated, nor does it indicate &#39;autoincrement=True&#39;,
and no explicit value is passed.  Primary key columns may not
store NULL. Note that as of SQLAlchemy 1.1, &#39;autoincrement=True&#39;
must be indicated explicitly for composite (e.g. multicolumn)
primary keys if AUTO_INCREMENT/SERIAL/IDENTITY behavior is
expected for one of the columns in the primary key. CREATE TABLE
statements are impacted by this change as well on most backends.</pre></div>
</div>
<p>For a column that is receiving primary key values from a server-side
default or something less common such as a trigger, the presence of a
value generator can be indicated using <a class="reference internal" href="../core/defaults.html#sqlalchemy.schema.FetchedValue" title="sqlalchemy.schema.FetchedValue"><code class="xref py py-class docutils literal"><span class="pre">FetchedValue</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Table</span><span class="p">(</span>
    <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">server_default</span><span class="o">=</span><span class="n">FetchedValue</span><span class="p">()),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">server_default</span><span class="o">=</span><span class="n">FetchedValue</span><span class="p">())</span>
<span class="p">)</span></pre></div>
</div>
<p>For the very unlikely case where a composite primary key is actually intended
to store NULL in one or more of its columns (only supported on SQLite and MySQL),
specify the column with <code class="docutils literal"><span class="pre">nullable=True</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Table</span><span class="p">(</span>
    <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p>In a related change, the <code class="docutils literal"><span class="pre">autoincrement</span></code> flag may be set to True
on a column that has a client-side or server-side default.  This typically
will not have much impact on the behavior of the column during an INSERT.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="#change-mysql-3216"><span>No more generation of an implicit KEY for composite primary key w/ AUTO_INCREMENT</span></a></p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3216">#3216</a></p>
</div>
<div class="section" id="a-union-or-similar-of-selects-with-limit-offset-order-by-now-parenthesizes-the-embedded-selects">
<span id="change-2528"></span><h3>A UNION or similar of SELECTs with LIMIT/OFFSET/ORDER BY now parenthesizes the embedded selects<a class="headerlink" href="#a-union-or-similar-of-selects-with-limit-offset-order-by-now-parenthesizes-the-embedded-selects" title="Permalink to this headline">¶</a></h3>
<p>An issue that, like others, was long driven by SQLite&#8217;s lack of capabilities
has now been enhanced to work on all supporting backends.   We refer to a query that
is a UNION of SELECT statements that themselves contain row-limiting or ordering
features which include LIMIT, OFFSET, and/or ORDER BY:</p>
<div class="highlight-python"><div class="highlight"><pre>(SELECT x FROM table1 ORDER BY y LIMIT 1) UNION
(SELECT x FROM table2 ORDER BY y LIMIT 2)</pre></div>
</div>
<p>The above query requires parenthesis within each sub-select in order to
group the sub-results correctly.  Production of the above statement in
SQLAlchemy Core looks like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">stmt1</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">table1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">table1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">stmt2</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">table1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">table2</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">stmt</span> <span class="o">=</span> <span class="n">union</span><span class="p">(</span><span class="n">stmt1</span><span class="p">,</span> <span class="n">stmt2</span><span class="p">)</span></pre></div>
</div>
<p>Previously, the above construct would not produce parenthesization for the
inner SELECT statements, producing a query that fails on all backends.</p>
<p>The above formats will <strong>continue to fail on SQLite</strong>; additionally, the format
that includes ORDER BY but no LIMIT/SELECT will <strong>continue to fail on Oracle</strong>.
This is not a backwards-incompatible change, because the queries fail without
the parentheses as well; with the fix, the queries at least work on all other
databases.</p>
<p>In all cases, in order to produce a UNION of limited SELECT statements that
also works on SQLite and in all cases on Oracle, the
subqueries must be a SELECT of an ALIAS:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">stmt1</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">table1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">table1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">stmt2</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">table2</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">table2</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>

<span class="n">stmt</span> <span class="o">=</span> <span class="n">union</span><span class="p">(</span><span class="n">stmt1</span><span class="p">,</span> <span class="n">stmt2</span><span class="p">)</span></pre></div>
</div>
<p>This workaround works on all SQLAlchemy versions.  In the ORM, it looks like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">stmt1</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Model1</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Model1</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">stmt2</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Model2</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Model2</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>

<span class="n">stmt</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Model1</span><span class="p">)</span><span class="o">.</span><span class="n">from_statement</span><span class="p">(</span><span class="n">stmt1</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">stmt2</span><span class="p">))</span></pre></div>
</div>
<p>The behavior here has many parallels to the &#8220;join rewriting&#8221; behavior
introduced in SQLAlchemy 0.9 in <a class="reference internal" href="migration_09.html#feature-joins-09"><span>Many JOIN and LEFT OUTER JOIN expressions will no longer be wrapped in (SELECT * FROM ..) AS ANON_1</span></a>; however in this case
we have opted not to add new rewriting behavior to accommodate this
case for SQLite.
The existing rewriting behavior is very complicated already, and the case of
UNIONs with parenthesized SELECT statements is much less common than the
&#8220;right-nested-join&#8221; use case of that feature.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2528">#2528</a></p>
</div>
<div class="section" id="array-support-added-to-core-new-any-and-all-operators">
<span id="change-3516"></span><h3>Array support added to Core; new ANY and ALL operators<a class="headerlink" href="#array-support-added-to-core-new-any-and-all-operators" title="Permalink to this headline">¶</a></h3>
<p>Along with the enhancements made to the Postgresql <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.ARRAY" title="sqlalchemy.dialects.postgresql.ARRAY"><code class="xref py py-class docutils literal"><span class="pre">ARRAY</span></code></a>
type described in <a class="reference internal" href="#change-3503"><span>Correct SQL Types are Established from Indexed Access of ARRAY, JSON, HSTORE</span></a>, the base class of <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.ARRAY" title="sqlalchemy.dialects.postgresql.ARRAY"><code class="xref py py-class docutils literal"><span class="pre">ARRAY</span></code></a>
itself has been moved to Core in a new class <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Array" title="sqlalchemy.types.Array"><code class="xref py py-class docutils literal"><span class="pre">types.Array</span></code></a>.</p>
<p>Arrays are part of the SQL standard, as are several array-oriented functions
such as <code class="docutils literal"><span class="pre">array_agg()</span></code> and <code class="docutils literal"><span class="pre">unnest()</span></code>.  In support of these constructs
for not just PostgreSQL but also potentially for other array-capable backends
in the future such as DB2, the majority of array logic for SQL expressions
is now in Core.   The <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Array" title="sqlalchemy.types.Array"><code class="xref py py-class docutils literal"><span class="pre">Array</span></code></a> type still <strong>only works on
Postgresql</strong>, however it can be used directly, supporting special array
use cases such as indexed access, as well as support for the ANY and ALL:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">mytable</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s">&quot;mytable&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="n">Array</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="p">)</span>

<span class="n">expr</span> <span class="o">=</span> <span class="n">mytable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span>

<span class="n">expr</span> <span class="o">=</span> <span class="n">mytable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span></pre></div>
</div>
<p>In support of ANY and ALL, the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Array" title="sqlalchemy.types.Array"><code class="xref py py-class docutils literal"><span class="pre">Array</span></code></a> type retains the same
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Array.Comparator.any" title="sqlalchemy.types.Array.Comparator.any"><code class="xref py py-meth docutils literal"><span class="pre">Array.Comparator.any()</span></code></a> and <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Array.Comparator.all" title="sqlalchemy.types.Array.Comparator.all"><code class="xref py py-meth docutils literal"><span class="pre">Array.Comparator.all()</span></code></a> methods
from the PostgreSQL type, but also exports these operations to new
standalone operator functions <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.any_" title="sqlalchemy.sql.expression.any_"><code class="xref py py-func docutils literal"><span class="pre">sql.expression.any_()</span></code></a> and
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.all_" title="sqlalchemy.sql.expression.all_"><code class="xref py py-func docutils literal"><span class="pre">sql.expression.all_()</span></code></a>.  These two functions work in more
of the traditional SQL way, allowing a right-side expression form such
as:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">any_</span><span class="p">,</span> <span class="n">all_</span>

<span class="n">select</span><span class="p">([</span><span class="n">mytable</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="mi">12</span> <span class="o">==</span> <span class="n">any_</span><span class="p">(</span><span class="n">mytable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span></pre></div>
</div>
<p>For the PostgreSQL-specific operators &#8220;contains&#8221;, &#8220;contained_by&#8221;, and
&#8220;overlaps&#8221;, one should continue to use the <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.ARRAY" title="sqlalchemy.dialects.postgresql.ARRAY"><code class="xref py py-class docutils literal"><span class="pre">postgresql.ARRAY</span></code></a>
type directly, which provides all functionality of the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Array" title="sqlalchemy.types.Array"><code class="xref py py-class docutils literal"><span class="pre">Array</span></code></a>
type as well.</p>
<p>The <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.any_" title="sqlalchemy.sql.expression.any_"><code class="xref py py-func docutils literal"><span class="pre">sql.expression.any_()</span></code></a> and <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.all_" title="sqlalchemy.sql.expression.all_"><code class="xref py py-func docutils literal"><span class="pre">sql.expression.all_()</span></code></a> operators
are open-ended at the Core level, however their interpretation by backend
databases is limited.  On the Postgresql backend, the two operators
<strong>only accept array values</strong>.  Whereas on the MySQL backend, they
<strong>only accept subquery values</strong>.  On MySQL, one can use an expression
such as:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">any_</span><span class="p">,</span> <span class="n">all_</span>

<span class="n">subq</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">mytable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
<span class="n">select</span><span class="p">([</span><span class="n">mytable</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="mi">12</span> <span class="o">&gt;</span> <span class="n">any_</span><span class="p">(</span><span class="n">subq</span><span class="p">))</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3516">#3516</a></p>
</div>
<div class="section" id="new-function-features-within-group-array-agg-and-set-aggregate-functions">
<span id="change-3132"></span><h3>New Function features, &#8220;WITHIN GROUP&#8221;, array_agg and set aggregate functions<a class="headerlink" href="#new-function-features-within-group-array-agg-and-set-aggregate-functions" title="Permalink to this headline">¶</a></h3>
<p>With the new <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Array" title="sqlalchemy.types.Array"><code class="xref py py-class docutils literal"><span class="pre">Array</span></code></a> type we can also implement a pre-typed
function for the <code class="docutils literal"><span class="pre">array_agg()</span></code> SQL function that returns an array,
which is now available using <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.array_agg" title="sqlalchemy.sql.functions.array_agg"><code class="xref py py-class docutils literal"><span class="pre">array_agg</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">func</span><span class="o">.</span><span class="n">array_agg</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">)])</span></pre></div>
</div>
<p>A Postgresql element for an aggregate ORDER BY is also added via
<a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.aggregate_order_by" title="sqlalchemy.dialects.postgresql.aggregate_order_by"><code class="xref py py-class docutils literal"><span class="pre">postgresql.aggregate_order_by</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy.dialects.postgresql</span> <span class="kn">import</span> <span class="n">aggregate_order_by</span>
<span class="n">expr</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">array_agg</span><span class="p">(</span><span class="n">aggregate_order_by</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">desc</span><span class="p">()))</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">expr</span><span class="p">])</span></pre></div>
</div>
<p>Producing:</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT array_agg(table1.a ORDER BY table1.b DESC) AS array_agg_1 FROM table1</pre></div>
</div>
<p>The PG dialect itself also provides an <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.array_agg" title="sqlalchemy.dialects.postgresql.array_agg"><code class="xref py py-func docutils literal"><span class="pre">postgresql.array_agg()</span></code></a> wrapper to
ensure the <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.ARRAY" title="sqlalchemy.dialects.postgresql.ARRAY"><code class="xref py py-class docutils literal"><span class="pre">postgresql.ARRAY</span></code></a> type:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy.dialects.postgresql</span> <span class="kn">import</span> <span class="n">array_agg</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">array_agg</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">)])</span></pre></div>
</div>
<p>Additionally, functions like <code class="docutils literal"><span class="pre">percentile_cont()</span></code>, <code class="docutils literal"><span class="pre">percentile_disc()</span></code>,
<code class="docutils literal"><span class="pre">rank()</span></code>, <code class="docutils literal"><span class="pre">dense_rank()</span></code> and others that require an ordering via
<code class="docutils literal"><span class="pre">WITHIN</span> <span class="pre">GROUP</span> <span class="pre">(ORDER</span> <span class="pre">BY</span> <span class="pre">&lt;expr&gt;)</span></code> are now available via the
<a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.FunctionElement.within_group" title="sqlalchemy.sql.functions.FunctionElement.within_group"><code class="xref py py-meth docutils literal"><span class="pre">FunctionElement.within_group()</span></code></a> modifier:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span>
    <span class="n">department</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
    <span class="n">func</span><span class="o">.</span><span class="n">percentile_cont</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">within_group</span><span class="p">(</span>
        <span class="n">department</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">salary</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span>
    <span class="p">)</span>
<span class="p">])</span></pre></div>
</div>
<p>The above statement would produce SQL similar to:</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT department.id, percentile_cont(0.5)
WITHIN GROUP (ORDER BY department.salary DESC)</pre></div>
</div>
<p>Placeholders with correct return types are now provided for these functions,
and include <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.percentile_cont" title="sqlalchemy.sql.functions.percentile_cont"><code class="xref py py-class docutils literal"><span class="pre">percentile_cont</span></code></a>, <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.percentile_disc" title="sqlalchemy.sql.functions.percentile_disc"><code class="xref py py-class docutils literal"><span class="pre">percentile_disc</span></code></a>,
<a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.rank" title="sqlalchemy.sql.functions.rank"><code class="xref py py-class docutils literal"><span class="pre">rank</span></code></a>, <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.dense_rank" title="sqlalchemy.sql.functions.dense_rank"><code class="xref py py-class docutils literal"><span class="pre">dense_rank</span></code></a>, <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.mode" title="sqlalchemy.sql.functions.mode"><code class="xref py py-class docutils literal"><span class="pre">mode</span></code></a>, <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.percent_rank" title="sqlalchemy.sql.functions.percent_rank"><code class="xref py py-class docutils literal"><span class="pre">percent_rank</span></code></a>,
and <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.cume_dist" title="sqlalchemy.sql.functions.cume_dist"><code class="xref py py-class docutils literal"><span class="pre">cume_dist</span></code></a>.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3132">#3132</a> <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/1370">#1370</a></p>
</div>
<div class="section" id="typedecorator-now-works-with-enum-boolean-schema-types-automatically">
<span id="change-2919"></span><h3>TypeDecorator now works with Enum, Boolean, &#8220;schema&#8221; types automatically<a class="headerlink" href="#typedecorator-now-works-with-enum-boolean-schema-types-automatically" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.SchemaType" title="sqlalchemy.types.SchemaType"><code class="xref py py-class docutils literal"><span class="pre">SchemaType</span></code></a> types include types such as <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal"><span class="pre">Enum</span></code></a>
and <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Boolean" title="sqlalchemy.types.Boolean"><code class="xref py py-class docutils literal"><span class="pre">Boolean</span></code></a> which, in addition to corresponding to a database
type, also generate either a CHECK constraint or in the case of Postgresql
ENUM a new CREATE TYPE statement, will now work automatically with
<a class="reference internal" href="../core/custom_types.html#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal"><span class="pre">TypeDecorator</span></code></a> recipes.  Previously, a <a class="reference internal" href="../core/custom_types.html#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal"><span class="pre">TypeDecorator</span></code></a> for
an <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.ENUM" title="sqlalchemy.dialects.postgresql.ENUM"><code class="xref py py-class docutils literal"><span class="pre">postgresql.ENUM</span></code></a> had to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># old way</span>
<span class="k">class</span> <span class="nc">MyEnum</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">,</span> <span class="n">SchemaType</span><span class="p">):</span>
    <span class="n">impl</span> <span class="o">=</span> <span class="n">postgresql</span><span class="o">.</span><span class="n">ENUM</span><span class="p">(</span><span class="s">&#39;one&#39;</span><span class="p">,</span> <span class="s">&#39;two&#39;</span><span class="p">,</span> <span class="s">&#39;three&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;myenum&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">_set_table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span></pre></div>
</div>
<p>The <a class="reference internal" href="../core/custom_types.html#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal"><span class="pre">TypeDecorator</span></code></a> now propagates those additional events so it
can be done like any other type:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># new way</span>
<span class="k">class</span> <span class="nc">MyEnum</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="n">impl</span> <span class="o">=</span> <span class="n">postgresql</span><span class="o">.</span><span class="n">ENUM</span><span class="p">(</span><span class="s">&#39;one&#39;</span><span class="p">,</span> <span class="s">&#39;two&#39;</span><span class="p">,</span> <span class="s">&#39;three&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;myenum&#39;</span><span class="p">)</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2919">#2919</a></p>
</div>
<div class="section" id="the-type-coerce-function-is-now-a-persistent-sql-element">
<span id="change-3531"></span><h3>The type_coerce function is now a persistent SQL element<a class="headerlink" href="#the-type-coerce-function-is-now-a-persistent-sql-element" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.type_coerce" title="sqlalchemy.sql.expression.type_coerce"><code class="xref py py-func docutils literal"><span class="pre">expression.type_coerce()</span></code></a> function previously would return
an object either of type <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.BindParameter" title="sqlalchemy.sql.expression.BindParameter"><code class="xref py py-class docutils literal"><span class="pre">BindParameter</span></code></a> or <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.Label" title="sqlalchemy.sql.expression.Label"><code class="xref py py-class docutils literal"><span class="pre">Label</span></code></a>, depending
on the input.  An effect this would have was that in the case where expression
transformations were used, such as the conversion of an element from a
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal"><span class="pre">Column</span></code></a> to a <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.BindParameter" title="sqlalchemy.sql.expression.BindParameter"><code class="xref py py-class docutils literal"><span class="pre">BindParameter</span></code></a> that&#8217;s critical to ORM-level
lazy loading, the type coercion information would not be used since it would
have been lost already.</p>
<p>To improve this behavior, the function now returns a persistent
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.TypeCoerce" title="sqlalchemy.sql.expression.TypeCoerce"><code class="xref py py-class docutils literal"><span class="pre">TypeCoerce</span></code></a> container around the given expression, which itself
remains unaffected; this construct is evaluated explicitly by the
SQL compiler.  This allows for the coercion of the inner expression
to be maintained no matter how the statement is modified, including if
the contained element is replaced with a different one, as is common
within the ORM&#8217;s lazy loading feature.</p>
<p>The test case illustrating the effect makes use of a heterogeneous
primaryjoin condition in conjunction with custom types and lazy loading.
Given a custom type that applies a CAST as a &#8220;bind expression&#8221;:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StringAsInt</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="n">impl</span> <span class="o">=</span> <span class="n">String</span>

    <span class="k">def</span> <span class="nf">column_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bind_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">String</span><span class="p">)</span></pre></div>
</div>
<p>Then, a mapping where we are equating a string &#8220;id&#8221; column on one
table to an integer &#8220;id&#8221; column on the other:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;person&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">StringAsInt</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">pets</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s">&#39;Pets&#39;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="p">(</span>
            <span class="s">&#39;foreign(Pets.person_id)&#39;</span>
            <span class="s">&#39;==cast(type_coerce(Person.id, Integer), Integer)&#39;</span>
        <span class="p">)</span>
    <span class="p">)</span>

<span class="k">class</span> <span class="nc">Pets</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;pets&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">person_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="s">&#39;person_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)</span></pre></div>
</div>
<p>Above, in the <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal"><span class="pre">relationship.primaryjoin</span></code></a> expression, we are
using <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.type_coerce" title="sqlalchemy.sql.expression.type_coerce"><code class="xref py py-func docutils literal"><span class="pre">type_coerce()</span></code></a> to handle bound parameters passed via
lazyloading as integers, since we already know these will come from
our <code class="docutils literal"><span class="pre">StringAsInt</span></code> type which maintains the value as an integer in
Python. We are then using <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.cast" title="sqlalchemy.sql.expression.cast"><code class="xref py py-func docutils literal"><span class="pre">cast()</span></code></a> so that as a SQL expression,
the VARCHAR &#8220;id&#8221;  column will be CAST to an integer for a regular non-
converted join as with <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.join" title="sqlalchemy.orm.query.Query.join"><code class="xref py py-meth docutils literal"><span class="pre">Query.join()</span></code></a> or <a class="reference internal" href="../orm/loading_relationships.html#sqlalchemy.orm.joinedload" title="sqlalchemy.orm.joinedload"><code class="xref py py-func docutils literal"><span class="pre">orm.joinedload()</span></code></a>.
That is, a joinedload of <code class="docutils literal"><span class="pre">.pets</span></code> looks like:</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT person.id AS person_id, pets_1.id AS pets_1_id,
       pets_1.person_id AS pets_1_person_id
FROM person
LEFT OUTER JOIN pets AS pets_1
ON pets_1.person_id = CAST(person.id AS INTEGER)</pre></div>
</div>
<p>Without the CAST in the ON clause of the join, strongly-typed databases
such as Postgresql will refuse to implicitly compare the integer and fail.</p>
<p>The lazyload case of <code class="docutils literal"><span class="pre">.pets</span></code> relies upon replacing
the <code class="docutils literal"><span class="pre">Person.id</span></code> column at load time with a bound parameter, which receives
a Python-loaded value.  This replacement is specifically where the intent
of our <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.type_coerce" title="sqlalchemy.sql.expression.type_coerce"><code class="xref py py-func docutils literal"><span class="pre">type_coerce()</span></code></a> function would be lost.  Prior to the change,
this lazy load comes out as:</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT pets.id AS pets_id, pets.person_id AS pets_person_id
FROM pets
WHERE pets.person_id = CAST(CAST(%(param_1)s AS VARCHAR) AS INTEGER)
{&#39;param_1&#39;: 5}</pre></div>
</div>
<p>Where above, we see that our in-Python value of <code class="docutils literal"><span class="pre">5</span></code> is CAST first
to a VARCHAR, then back to an INTEGER in SQL; a double CAST which works,
but is nevertheless not what we asked for.</p>
<p>With the change, the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.type_coerce" title="sqlalchemy.sql.expression.type_coerce"><code class="xref py py-func docutils literal"><span class="pre">type_coerce()</span></code></a> function maintains a wrapper
even after the column is swapped out for a bound parameter, and the query now
looks like:</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT pets.id AS pets_id, pets.person_id AS pets_person_id
FROM pets
WHERE pets.person_id = CAST(%(param_1)s AS INTEGER)
{&#39;param_1&#39;: 5}</pre></div>
</div>
<p>Where our outer CAST that&#8217;s in our primaryjoin still takes effect, but the
needless CAST that&#8217;s in part of the <code class="docutils literal"><span class="pre">StringAsInt</span></code> custom type is removed
as intended by the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.type_coerce" title="sqlalchemy.sql.expression.type_coerce"><code class="xref py py-func docutils literal"><span class="pre">type_coerce()</span></code></a> function.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3531">#3531</a></p>
</div>
</div>
<div class="section" id="key-behavioral-changes-orm">
<h2>Key Behavioral Changes - ORM<a class="headerlink" href="#key-behavioral-changes-orm" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="key-behavioral-changes-core">
<h2>Key Behavioral Changes - Core<a class="headerlink" href="#key-behavioral-changes-core" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="dialect-improvements-and-changes-postgresql">
<h2>Dialect Improvements and Changes - Postgresql<a class="headerlink" href="#dialect-improvements-and-changes-postgresql" title="Permalink to this headline">¶</a></h2>
<div class="section" id="array-and-json-types-now-correctly-specify-unhashable">
<span id="change-3499-postgresql"></span><h3>ARRAY and JSON types now correctly specify &#8220;unhashable&#8221;<a class="headerlink" href="#array-and-json-types-now-correctly-specify-unhashable" title="Permalink to this headline">¶</a></h3>
<p>As described in <a class="reference internal" href="#change-3499"><span>Changes regarding &#8220;unhashable&#8221; types</span></a>, the ORM relies upon being able to
produce a hash function for column values when a query&#8217;s selected entities
mixes full ORM entities with column expressions.   The <code class="docutils literal"><span class="pre">hashable=False</span></code>
flag is now correctly set on all of PG&#8217;s &#8220;data structure&#8221; types, including
<a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.ARRAY" title="sqlalchemy.dialects.postgresql.ARRAY"><code class="xref py py-class docutils literal"><span class="pre">ARRAY</span></code></a> and <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON" title="sqlalchemy.dialects.postgresql.JSON"><code class="xref py py-class docutils literal"><span class="pre">JSON</span></code></a>.  The <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSONB" title="sqlalchemy.dialects.postgresql.JSONB"><code class="xref py py-class docutils literal"><span class="pre">JSONB</span></code></a> and <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.HSTORE" title="sqlalchemy.dialects.postgresql.HSTORE"><code class="xref py py-class docutils literal"><span class="pre">HSTORE</span></code></a>
types already included this flag.  For <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.ARRAY" title="sqlalchemy.dialects.postgresql.ARRAY"><code class="xref py py-class docutils literal"><span class="pre">ARRAY</span></code></a>,
this is conditional based on the <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.ARRAY.params.as_tuple" title="sqlalchemy.dialects.postgresql.ARRAY"><code class="xref py py-paramref docutils literal"><span class="pre">postgresql.ARRAY.as_tuple</span></code></a>
flag, however it should no longer be necessary to set this flag
in order to have an array value present in a composed ORM row.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p><a class="reference internal" href="#change-3499"><span>Changes regarding &#8220;unhashable&#8221; types</span></a></p>
<p class="last"><a class="reference internal" href="#change-3503"><span>Correct SQL Types are Established from Indexed Access of ARRAY, JSON, HSTORE</span></a></p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3499">#3499</a></p>
</div>
<div class="section" id="correct-sql-types-are-established-from-indexed-access-of-array-json-hstore">
<span id="change-3503"></span><h3>Correct SQL Types are Established from Indexed Access of ARRAY, JSON, HSTORE<a class="headerlink" href="#correct-sql-types-are-established-from-indexed-access-of-array-json-hstore" title="Permalink to this headline">¶</a></h3>
<p>For all three of <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.ARRAY" title="sqlalchemy.dialects.postgresql.ARRAY"><code class="xref py py-class docutils literal"><span class="pre">ARRAY</span></code></a>, <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON" title="sqlalchemy.dialects.postgresql.JSON"><code class="xref py py-class docutils literal"><span class="pre">JSON</span></code></a> and <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.HSTORE" title="sqlalchemy.dialects.postgresql.HSTORE"><code class="xref py py-class docutils literal"><span class="pre">HSTORE</span></code></a>,
the SQL type assigned to the expression returned by indexed access, e.g.
<code class="docutils literal"><span class="pre">col[someindex]</span></code>, should be correct in all cases.</p>
<p>This includes:</p>
<ul>
<li><p class="first">The SQL type assigned to indexed access of an <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.ARRAY" title="sqlalchemy.dialects.postgresql.ARRAY"><code class="xref py py-class docutils literal"><span class="pre">ARRAY</span></code></a> takes into
account the number of dimensions configured.   An <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.ARRAY" title="sqlalchemy.dialects.postgresql.ARRAY"><code class="xref py py-class docutils literal"><span class="pre">ARRAY</span></code></a> with three
dimensions will return a SQL expression with a type of <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.ARRAY" title="sqlalchemy.dialects.postgresql.ARRAY"><code class="xref py py-class docutils literal"><span class="pre">ARRAY</span></code></a> of
one less dimension.  Given a column with type <code class="docutils literal"><span class="pre">ARRAY(Integer,</span> <span class="pre">dimensions=3)</span></code>,
we can now perform this expression:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">int_expr</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">6</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span>   <span class="c"># returns an Integer expression object</span></pre></div>
</div>
<p>Previously, the indexed access to <code class="docutils literal"><span class="pre">col[5]</span></code> would return an expression of
type <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Integer" title="sqlalchemy.types.Integer"><code class="xref py py-class docutils literal"><span class="pre">Integer</span></code></a> where we could no longer perform indexed access
for the remaining dimensions, unless we used <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.cast" title="sqlalchemy.sql.expression.cast"><code class="xref py py-func docutils literal"><span class="pre">cast()</span></code></a> or <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.type_coerce" title="sqlalchemy.sql.expression.type_coerce"><code class="xref py py-func docutils literal"><span class="pre">type_coerce()</span></code></a>.</p>
</li>
<li><p class="first">The <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON" title="sqlalchemy.dialects.postgresql.JSON"><code class="xref py py-class docutils literal"><span class="pre">JSON</span></code></a> and <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSONB" title="sqlalchemy.dialects.postgresql.JSONB"><code class="xref py py-class docutils literal"><span class="pre">JSONB</span></code></a> types now mirror what Postgresql
itself does for indexed access.  This means that all indexed access for
a <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON" title="sqlalchemy.dialects.postgresql.JSON"><code class="xref py py-class docutils literal"><span class="pre">JSON</span></code></a> or <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSONB" title="sqlalchemy.dialects.postgresql.JSONB"><code class="xref py py-class docutils literal"><span class="pre">JSONB</span></code></a> type returns an expression that itself
is <em>always</em> <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON" title="sqlalchemy.dialects.postgresql.JSON"><code class="xref py py-class docutils literal"><span class="pre">JSON</span></code></a> or <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSONB" title="sqlalchemy.dialects.postgresql.JSONB"><code class="xref py py-class docutils literal"><span class="pre">JSONB</span></code></a> itself, unless the
<a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON.Comparator.astext" title="sqlalchemy.dialects.postgresql.JSON.Comparator.astext"><code class="xref py py-attr docutils literal"><span class="pre">astext</span></code></a> modifier is used.   This means that whether
the indexed access of the JSON structure ultimately refers to a string,
list, number, or other JSON structure, Postgresql always considers it
to be JSON itself unless it is explicitly cast differently.   Like
the <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.ARRAY" title="sqlalchemy.dialects.postgresql.ARRAY"><code class="xref py py-class docutils literal"><span class="pre">ARRAY</span></code></a> type, this means that it is now straightforward
to produce JSON expressions with multiple levels of indexed access:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">json_expr</span> <span class="o">=</span> <span class="n">json_col</span><span class="p">[</span><span class="s">&#39;key1&#39;</span><span class="p">][</span><span class="s">&#39;attr1&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span></pre></div>
</div>
</li>
<li><p class="first">The &#8220;textual&#8221; type that is returned by indexed access of <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.HSTORE" title="sqlalchemy.dialects.postgresql.HSTORE"><code class="xref py py-class docutils literal"><span class="pre">HSTORE</span></code></a>
as well as the &#8220;textual&#8221; type that is returned by indexed access of
<a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON" title="sqlalchemy.dialects.postgresql.JSON"><code class="xref py py-class docutils literal"><span class="pre">JSON</span></code></a> and <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSONB" title="sqlalchemy.dialects.postgresql.JSONB"><code class="xref py py-class docutils literal"><span class="pre">JSONB</span></code></a> in conjunction with the
<a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON.Comparator.astext" title="sqlalchemy.dialects.postgresql.JSON.Comparator.astext"><code class="xref py py-attr docutils literal"><span class="pre">astext</span></code></a> modifier is now configurable; it defaults
to <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Text" title="sqlalchemy.types.Text"><code class="xref py py-class docutils literal"><span class="pre">Text</span></code></a> in both cases but can be set to a user-defined
type using the <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON.params.astext_type" title="sqlalchemy.dialects.postgresql.JSON"><code class="xref py py-paramref docutils literal"><span class="pre">postgresql.JSON.astext_type</span></code></a> or
<a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.HSTORE.params.text_type" title="sqlalchemy.dialects.postgresql.HSTORE"><code class="xref py py-paramref docutils literal"><span class="pre">postgresql.HSTORE.text_type</span></code></a> parameters.</p>
</li>
</ul>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="#change-3503-cast"><span>The JSON cast() operation now requires .astext is called explicitly</span></a></p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3499">#3499</a>
<a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3487">#3487</a></p>
</div>
<div class="section" id="the-json-cast-operation-now-requires-astext-is-called-explicitly">
<span id="change-3503-cast"></span><h3>The JSON cast() operation now requires <code class="docutils literal"><span class="pre">.astext</span></code> is called explicitly<a class="headerlink" href="#the-json-cast-operation-now-requires-astext-is-called-explicitly" title="Permalink to this headline">¶</a></h3>
<p>As part of the changes in <a class="reference internal" href="#change-3503"><span>Correct SQL Types are Established from Indexed Access of ARRAY, JSON, HSTORE</span></a>, the workings of the
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnElement.cast" title="sqlalchemy.sql.expression.ColumnElement.cast"><code class="xref py py-meth docutils literal"><span class="pre">ColumnElement.cast()</span></code></a> operator on <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON" title="sqlalchemy.dialects.postgresql.JSON"><code class="xref py py-class docutils literal"><span class="pre">postgresql.JSON</span></code></a> and
<a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSONB" title="sqlalchemy.dialects.postgresql.JSONB"><code class="xref py py-class docutils literal"><span class="pre">postgresql.JSONB</span></code></a> no longer implictly invoke the
<a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON.Comparator.astext" title="sqlalchemy.dialects.postgresql.JSON.Comparator.astext"><code class="xref py py-attr docutils literal"><span class="pre">JSON.Comparator.astext</span></code></a> modifier; Postgresql&#8217;s JSON/JSONB types
support CAST operations to each other without the &#8220;astext&#8221; aspect.</p>
<p>This means that in most cases, an application that was doing this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">expr</span> <span class="o">=</span> <span class="n">json_col</span><span class="p">[</span><span class="s">&#39;somekey&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span></pre></div>
</div>
<p>Will now need to change to this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">expr</span> <span class="o">=</span> <span class="n">json_col</span><span class="p">[</span><span class="s">&#39;somekey&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span></pre></div>
</div>
</div>
<div class="section" id="postgresql-json-null-is-inserted-as-expected-with-orm-operations-regardless-of-column-default-present">
<span id="change-3514"></span><h3>Postgresql JSON &#8220;null&#8221; is inserted as expected with ORM operations, regardless of column default present<a class="headerlink" href="#postgresql-json-null-is-inserted-as-expected-with-orm-operations-regardless-of-column-default-present" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON" title="sqlalchemy.dialects.postgresql.JSON"><code class="xref py py-class docutils literal"><span class="pre">JSON</span></code></a> type has a flag <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON.params.none_as_null" title="sqlalchemy.dialects.postgresql.JSON"><code class="xref py py-paramref docutils literal"><span class="pre">JSON.none_as_null</span></code></a> which
when set to True indicates that the Python value <code class="docutils literal"><span class="pre">None</span></code> should translate
into a SQL NULL rather than a JSON NULL value.  This flag defaults to False,
which means that the column should <em>never</em> insert SQL NULL or fall back
to a default unless the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.null" title="sqlalchemy.sql.expression.null"><code class="xref py py-func docutils literal"><span class="pre">null()</span></code></a> constant were used.  However, this would
fail in the ORM under two circumstances; one is when the column also contained
a default or server_default value, a positive value of <code class="docutils literal"><span class="pre">None</span></code> on the mapped
attribute would still result in the column-level default being triggered,
replacing the <code class="docutils literal"><span class="pre">None</span></code> value:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">obj</span> <span class="o">=</span> <span class="n">MyObject</span><span class="p">(</span><span class="n">json_value</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>   <span class="c"># would fire off default / server_default, not encode &quot;&#39;none&#39;&quot;</span></pre></div>
</div>
<p>The other is when the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session.bulk_insert_mappings" title="sqlalchemy.orm.session.Session.bulk_insert_mappings"><code class="xref py py-meth docutils literal"><span class="pre">Session.bulk_insert_mappings()</span></code></a>
method were used, <code class="docutils literal"><span class="pre">None</span></code> would be ignored in all cases:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">session</span><span class="o">.</span><span class="n">bulk_insert_mappings</span><span class="p">(</span>
    <span class="n">MyObject</span><span class="p">,</span>
    <span class="p">[{</span><span class="s">&quot;json_value&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}])</span>  <span class="c"># would insert SQL NULL and/or trigger defaults</span></pre></div>
</div>
<p>The <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON" title="sqlalchemy.dialects.postgresql.JSON"><code class="xref py py-class docutils literal"><span class="pre">JSON</span></code></a> type now implements the
<a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine.should_evaluate_none" title="sqlalchemy.types.TypeEngine.should_evaluate_none"><code class="xref py py-attr docutils literal"><span class="pre">TypeEngine.should_evaluate_none</span></code></a> flag,
indicating that <code class="docutils literal"><span class="pre">None</span></code> should not be ignored here; it is configured
automatically based on the value of <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON.params.none_as_null" title="sqlalchemy.dialects.postgresql.JSON"><code class="xref py py-paramref docutils literal"><span class="pre">JSON.none_as_null</span></code></a>.
Thanks to <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3061">#3061</a>, we can differentiate when the value <code class="docutils literal"><span class="pre">None</span></code> is actively
set by the user versus when it was never set at all.</p>
<p>If the attribute is not set at all, then column level defaults <em>will</em>
fire off and/or SQL NULL will be inserted as expected, as was the behavior
previously.  Below, the two variants are illustrated:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">obj</span> <span class="o">=</span> <span class="n">MyObject</span><span class="p">(</span><span class="n">json_value</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>   <span class="c"># *will not* fire off column defaults, will insert JSON &#39;null&#39;</span>

<span class="n">obj</span> <span class="o">=</span> <span class="n">MyObject</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>   <span class="c"># *will* fire off column defaults, and/or insert SQL NULL</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3514">#3514</a></p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p><a class="reference internal" href="#change-3250"><span>New options allowing explicit persistence of NULL over a default</span></a></p>
<p class="last"><a class="reference internal" href="#change-3514-jsonnull"><span>New JSON.NULL Constant Added</span></a></p>
</div>
</div>
<div class="section" id="new-json-null-constant-added">
<span id="change-3514-jsonnull"></span><h3>New JSON.NULL Constant Added<a class="headerlink" href="#new-json-null-constant-added" title="Permalink to this headline">¶</a></h3>
<p>To ensure that an application can always have full control at the value level
of whether a <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON" title="sqlalchemy.dialects.postgresql.JSON"><code class="xref py py-class docutils literal"><span class="pre">postgresql.JSON</span></code></a> or <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSONB" title="sqlalchemy.dialects.postgresql.JSONB"><code class="xref py py-class docutils literal"><span class="pre">postgresql.JSONB</span></code></a> column
should receive a SQL NULL or JSON <code class="docutils literal"><span class="pre">&quot;null&quot;</span></code> value, the constant
<a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON.NULL" title="sqlalchemy.dialects.postgresql.JSON.NULL"><code class="xref py py-attr docutils literal"><span class="pre">postgresql.JSON.NULL</span></code></a> has been added, which in conjunction with
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.null" title="sqlalchemy.sql.expression.null"><code class="xref py py-func docutils literal"><span class="pre">null()</span></code></a> can be used to determine fully between SQL NULL and
JSON <code class="docutils literal"><span class="pre">&quot;null&quot;</span></code>, regardless of what <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON.params.none_as_null" title="sqlalchemy.dialects.postgresql.JSON"><code class="xref py py-paramref docutils literal"><span class="pre">JSON.none_as_null</span></code></a> is set
to:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">null</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects.postgresql</span> <span class="kn">import</span> <span class="n">JSON</span>

<span class="n">obj1</span> <span class="o">=</span> <span class="n">MyObject</span><span class="p">(</span><span class="n">json_value</span><span class="o">=</span><span class="n">null</span><span class="p">())</span>  <span class="c"># will *always* insert SQL NULL</span>
<span class="n">obj2</span> <span class="o">=</span> <span class="n">MyObject</span><span class="p">(</span><span class="n">json_value</span><span class="o">=</span><span class="n">JSON</span><span class="o">.</span><span class="n">NULL</span><span class="p">)</span>  <span class="c"># will *always* insert JSON string &quot;null&quot;</span>

<span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span><span class="n">obj1</span><span class="p">,</span> <span class="n">obj2</span><span class="p">])</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="#change-3514"><span>Postgresql JSON &#8220;null&#8221; is inserted as expected with ORM operations, regardless of column default present</span></a></p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3514">#3514</a></p>
</div>
<div class="section" id="array-with-enum-will-now-emit-create-type-for-the-enum">
<span id="change-2729"></span><h3>ARRAY with ENUM will now emit CREATE TYPE for the ENUM<a class="headerlink" href="#array-with-enum-will-now-emit-create-type-for-the-enum" title="Permalink to this headline">¶</a></h3>
<p>A table definition like the following will now emit CREATE TYPE
as expected:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">enum</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span>
    <span class="s">&#39;manager&#39;</span><span class="p">,</span> <span class="s">&#39;place_admin&#39;</span><span class="p">,</span> <span class="s">&#39;carwash_admin&#39;</span><span class="p">,</span>
    <span class="s">&#39;parking_admin&#39;</span><span class="p">,</span> <span class="s">&#39;service_admin&#39;</span><span class="p">,</span> <span class="s">&#39;tire_admin&#39;</span><span class="p">,</span>
    <span class="s">&#39;mechanic&#39;</span><span class="p">,</span> <span class="s">&#39;carwasher&#39;</span><span class="p">,</span> <span class="s">&#39;tire_mechanic&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;work_place_roles&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">WorkPlacement</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;work_placement&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ARRAY</span><span class="p">(</span><span class="n">enum</span><span class="p">))</span>


<span class="n">e</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">&quot;postgresql://scott:tiger@localhost/test&quot;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></pre></div>
</div>
<p>emits:</p>
<div class="highlight-python"><div class="highlight"><pre>CREATE TYPE work_place_roles AS ENUM (
    &#39;manager&#39;, &#39;place_admin&#39;, &#39;carwash_admin&#39;, &#39;parking_admin&#39;,
    &#39;service_admin&#39;, &#39;tire_admin&#39;, &#39;mechanic&#39;, &#39;carwasher&#39;,
    &#39;tire_mechanic&#39;)

CREATE TABLE work_placement (
    id SERIAL NOT NULL,
    roles work_place_roles[],
    PRIMARY KEY (id)
)</pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2729">#2729</a></p>
</div>
</div>
<div class="section" id="dialect-improvements-and-changes-mysql">
<h2>Dialect Improvements and Changes - MySQL<a class="headerlink" href="#dialect-improvements-and-changes-mysql" title="Permalink to this headline">¶</a></h2>
<div class="section" id="no-more-generation-of-an-implicit-key-for-composite-primary-key-w-auto-increment">
<span id="change-mysql-3216"></span><h3>No more generation of an implicit KEY for composite primary key w/ AUTO_INCREMENT<a class="headerlink" href="#no-more-generation-of-an-implicit-key-for-composite-primary-key-w-auto-increment" title="Permalink to this headline">¶</a></h3>
<p>The MySQL dialect had the behavior such that if a composite primary key
on an InnoDB table featured AUTO_INCREMENT on one of its columns which was
not the first column, e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s">&#39;some_table&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">mysql_engine</span><span class="o">=</span><span class="s">&#39;InnoDB&#39;</span>
<span class="p">)</span></pre></div>
</div>
<p>DDL such as the following would be generated:</p>
<div class="highlight-python"><div class="highlight"><pre>CREATE TABLE some_table (
    x INTEGER NOT NULL,
    y INTEGER NOT NULL AUTO_INCREMENT,
    PRIMARY KEY (x, y),
    KEY idx_autoinc_y (y)
)ENGINE=InnoDB</pre></div>
</div>
<p>Note the above &#8220;KEY&#8221; with an auto-generated name; this is a change that
found its way into the dialect many years ago in response to the issue that
the AUTO_INCREMENT would otherwise fail on InnoDB without this additional KEY.</p>
<p>This workaround has been removed and replaced with the much better system
of just stating the AUTO_INCREMENT column <em>first</em> within the primary key:</p>
<div class="highlight-python"><div class="highlight"><pre>CREATE TABLE some_table (
    x INTEGER NOT NULL,
    y INTEGER NOT NULL AUTO_INCREMENT,
    PRIMARY KEY (y, x)
)ENGINE=InnoDB</pre></div>
</div>
<p>Along with the change <a class="reference internal" href="#change-3216"><span>The .autoincrement directive is no longer implicitly enabled for a composite primary key column</span></a>, composite primary keys with
or without auto increment are now easier to specify;
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.autoincrement" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal"><span class="pre">Column.autoincrement</span></code></a>
now defaults to the value <code class="docutils literal"><span class="pre">&quot;auto&quot;</span></code> and the <code class="docutils literal"><span class="pre">autoincrement=False</span></code>
directives are no longer needed:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s">&#39;some_table&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">mysql_engine</span><span class="o">=</span><span class="s">&#39;InnoDB&#39;</span>
<span class="p">)</span></pre></div>
</div>
</div>
</div>
<div class="section" id="dialect-improvements-and-changes-sqlite">
<h2>Dialect Improvements and Changes - SQLite<a class="headerlink" href="#dialect-improvements-and-changes-sqlite" title="Permalink to this headline">¶</a></h2>
<div class="section" id="improved-support-for-remote-schemas">
<span id="change-sqlite-schemas"></span><h3>Improved Support for Remote Schemas<a class="headerlink" href="#improved-support-for-remote-schemas" title="Permalink to this headline">¶</a></h3>
<p>The SQLite dialect now implements <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_schema_names" title="sqlalchemy.engine.reflection.Inspector.get_schema_names"><code class="xref py py-meth docutils literal"><span class="pre">Inspector.get_schema_names()</span></code></a>
and additionally has improved support for tables and indexes that are
created and reflected from a remote schema, which in SQLite is a
database that is assigned a name via the <code class="docutils literal"><span class="pre">ATTACH</span></code> statement; previously,
the <code class="docutils literal"><span class="pre">CREATE</span> <span class="pre">INDEX</span></code> DDL didn&#8217;t work correctly for a schema-bound table
and the <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_foreign_keys" title="sqlalchemy.engine.reflection.Inspector.get_foreign_keys"><code class="xref py py-meth docutils literal"><span class="pre">Inspector.get_foreign_keys()</span></code></a> method will now indicate the
given schema in the results.  Cross-schema foreign keys aren&#8217;t supported.</p>
</div>
</div>
<div class="section" id="dialect-improvements-and-changes-sql-server">
<h2>Dialect Improvements and Changes - SQL Server<a class="headerlink" href="#dialect-improvements-and-changes-sql-server" title="Permalink to this headline">¶</a></h2>
<div class="section" id="string-varlength-types-no-longer-represent-max-explicitly-on-reflection">
<span id="change-3504"></span><h3>String / varlength types no longer represent &#8220;max&#8221; explicitly on reflection<a class="headerlink" href="#string-varlength-types-no-longer-represent-max-explicitly-on-reflection" title="Permalink to this headline">¶</a></h3>
<p>When reflecting a type such as <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.String" title="sqlalchemy.types.String"><code class="xref py py-class docutils literal"><span class="pre">String</span></code></a>, <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Text" title="sqlalchemy.types.Text"><code class="xref py py-class docutils literal"><span class="pre">Text</span></code></a>, etc.
which includes a length, an &#8220;un-lengthed&#8221; type under SQL Server would
copy the &#8220;length&#8221; parameter as the value <code class="docutils literal"><span class="pre">&quot;max&quot;</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">inspect</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">&#39;mssql+pyodbc://scott:tiger@ms_2008&#39;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;create table s (x varchar(max), y varbinary(max))&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">insp</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">insp</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="s">&quot;s&quot;</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">col</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">col</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">length</span>
<span class="gp">...</span>
<span class="go">&lt;class &#39;sqlalchemy.sql.sqltypes.VARCHAR&#39;&gt; max</span>
<span class="go">&lt;class &#39;sqlalchemy.dialects.mssql.base.VARBINARY&#39;&gt; max</span></pre></div>
</div>
<p>The &#8220;length&#8221; parameter in the base types is expected to be an integer value
or None only; None indicates unbounded length which the SQL Server dialect
interprets as &#8220;max&#8221;.   The fix then is so that these lengths come
out as None, so that the type objects work in non-SQL Server contexts:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">insp</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="s">&quot;s&quot;</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">col</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">col</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">length</span>
<span class="gp">...</span>
<span class="go">&lt;class &#39;sqlalchemy.sql.sqltypes.VARCHAR&#39;&gt; None</span>
<span class="go">&lt;class &#39;sqlalchemy.dialects.mssql.base.VARBINARY&#39;&gt; None</span></pre></div>
</div>
<p>Applications which may have been relying on a direct comparison of the &#8220;length&#8221;
value to the string &#8220;max&#8221; should consider the value of <code class="docutils literal"><span class="pre">None</span></code> to mean
the same thing.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3504">#3504</a></p>
</div>
<div class="section" id="the-legacy-schema-aliasing-flag-is-now-set-to-false">
<span id="change-3434"></span><h3>The legacy_schema_aliasing flag is now set to False<a class="headerlink" href="#the-legacy-schema-aliasing-flag-is-now-set-to-false" title="Permalink to this headline">¶</a></h3>
<p>SQLAlchemy 1.0.5 introduced the <code class="docutils literal"><span class="pre">legacy_schema_aliasing</span></code> flag to the
MSSQL dialect, allowing so-called &#8220;legacy mode&#8221; aliasing to be turned off.
This aliasing attempts to turn schema-qualified tables into aliases;
given a table such as:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">account_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s">&#39;account&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;info&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">)),</span>
    <span class="n">schema</span><span class="o">=</span><span class="s">&quot;customer_schema&quot;</span>
<span class="p">)</span></pre></div>
</div>
<p>The legacy mode of behavior will attempt to turn a schema-qualified table
name into an alias:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">eng</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">&quot;mssql+pymssql://mydsn&quot;</span><span class="p">,</span> <span class="n">legacy_schema_aliasing</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">account_table</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">eng</span><span class="p">))</span>
<span class="go">SELECT account_1.id, account_1.info</span>
<span class="go">FROM customer_schema.account AS account_1</span></pre></div>
</div>
<p>However, this aliasing has been shown to be unnecessary and in many cases
produces incorrect SQL.</p>
<p>In SQLAlchemy 1.1, the <code class="docutils literal"><span class="pre">legacy_schema_aliasing</span></code> flag now defaults to
False, disabling this mode of behavior and allowing the MSSQL dialect to behave
normally with schema-qualified tables.  For applications which may rely
on this behavior, set the flag back to True.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3434">#3434</a></p>
</div>
</div>
<div class="section" id="dialect-improvements-and-changes-oracle">
<h2>Dialect Improvements and Changes - Oracle<a class="headerlink" href="#dialect-improvements-and-changes-oracle" title="Permalink to this headline">¶</a></h2>
</div>
</div>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links">
        Previous:
        <a href="index.html" title="previous chapter">Changes and Migration</a>
        Next:
        <a href="changelog_11.html" title="next chapter">1.1 Changelog</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2015, the SQLAlchemy authors and contributors.
        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.3.
    </div>
</div>

</div>


        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '1.1.0b1',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/detectmobile.js"></script>
    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


